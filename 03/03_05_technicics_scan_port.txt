
Эффективность техники сканирования портов

Эффективность техники измеряется в ее:

    Скорости
    Скрытности
    Качестве результатов

Как повысить эффективность техники

1. Для оптимизации скорости сканирования — можно использовать шаблоны управления временем с помощью ключа -Т. Возможные варианты: paranoid(0), sneaky(1), polite(2), normal(3), aggressive(4) и insane(5).

Первые два помогают уклоняться от идентификации атакующего. 2 режим замедляет сканирование. 3 режим — по умолчанию, то есть никакой оптимизации не будет по данному ключу. 4 режим ускоряет сканирование. 5 режим очень быстро сканирует, но есть вероятность в потере точности при сканировании.

    Пример: nmap -Т4 <example.com>.

Также возможна ситуация, когда нужно получить быстрый и максимально информативный результат сканирования сетевых портов. Для этого можно использовать ключ --top-ports <количество_портов>. Данный ключ сканирует заданное количество портов по рейтингу их популярности. Так же можно использовать ключ -F, который позволяет использовать сетевые пакеты минимального объёма. Ещё возможна ситуация, когда нас интересует лишь конкретные порты узла. Для этого можно использовать ключ -p <номер_порта>.

Список популярных сетевых портов

На сетевых периметрах часто встречаются UDP-сервисы DNS (53), NTP (123), SNMP (161), VPN (500, 1194, 4500), RDG (3391). Реже встречаются сервисные службы типа echo (7), discard (9), chargen (19), а также DAYTIME (13), TFTP (69), SIP (5060), сервисы NFS (2049), RPC (111, 137-139, 761 и др.), СУБД (1434).

Расширенный список:

    21 — ftp
    22 — ssh
    23 — telnet
    80, 8000, 8001, 8002, 8004, 8006, 8007, 8008, 8080, 8888 — http
    88 — kerberos
    139 — netbios
    143 — imap
    389 — ldap
    443, 8443, 9443 — https
    445 — smb
    623, 49152 — ipmi
    636 — ldaps
    873 — rsync
    1099 — websphere
    1433, 1434 — mssql
    1500 — tivoli_storage_manager
    1540, 1541 — 1С
    2001, 2010 — ibm_http
    2181 — zookeeper
    2222 — ansible
    2375, 2376 — docker
    2379 — k8s etcd
    2809, 9043, 9060, 9080, 9501, 9502, 9503 — websphere
    5558, 5559 — websphere_java_messaging_serevice
    7873 — websphere_rds_client
    8879 — websphere_soap
    3306 — mysql
    3389 — rdp
    4678 — cisco smart install
    4899 — radmin
    5800 — 5810,5900,5901 — vnc
    5432, 5433 — postgresql
    5555 — hp_data_protector
    5557 — citrix
    5666 — nagious
    8291 — mikrotik
    10050, 10051 — zabbix
    7001 — weblogic
    9000 — clickhouse
    27017, 27018 — mongodb
    50013 — sap
    1521 — 1527 — oracle
    3200 — 3299 — sap
    4786 — cisco_smart_install
    9200, 9300 — elasticsearch
    5985, 5986 — winrm
    50070 — hdfs_ui
    6443 — k8s
    8111 — click_house
    8500, 8501 — consul
    8200, 8201 — vault
    10250, 10255 — k8s

Увеличению скорости сканирования способствует флаг -n, который говорит, что не надо преобразовывать адреса обнаруженных узлов в DNS - адреса.

********************* important ***************************
2. Для лучшей скрытности сканирования — в локальных сетях можно использовать ключ -spoof-mac для изменения MAC адреса атакующего узла и флаг -S для изменения его IP адреса.

3. Качество результатов

    Если стоит задача проверить все возможные номера сетевых портов, то следует использовать ключ -p-.
********************* important ***************************    
    Если очень много информации о результате сканирования, то для удобства изучения можно перенаправить вывод информации в текстовый файл с помощью ключа -oN <имя_файла> 
    Если есть список IP адресов, которые подлежат проверке состояния их сетевых портов, то можно использовать ключ -iL <имя_файла>, где в качестве имени файла передаётся файл с нужными IP адресами.

4. Комбинации 

Улучшить технику сканирования можно за счёт использования сильных сторон тех или иных инструментов и комбинирования их между собой.

    Пример: nmap сканирует сетевые порты довольно медленно, но качественно, с помощью этого инструмента можно уточнять состояния портов. Но перед этим можно просканировать узел или узлы с помощью намного более быстрого инструмента — masscan и после этого лишь уточнить достоверность его результатов сканирования с помощью nmap.

У nmap есть свой набор скриптов, которые способны дать определённую информацию при сканировании. Они делятся на следующие типы: safe, (intrusive), malware, version, discovery, vuln, auth и default. Что бы при сканировании работал какой — то конкретный скрипт или группа скриптов, то следует запускать с ключом —script.

    Пример: sudo nmap --script <категории - скриптов>|<директория>|<имя_файла>|all <example.com>.

Также, возможно, некоторым скриптам нужно передавать значения. Это делается следующим образом: —script-args <имя1>=<значение1>, <имя2>={<имя3>=<значение3>}, <имя4>=<значение4>. Данные скрипты позволяют выполнять параллельные действия над сканируемыми сетевыми портами.

Также для улучшения техники сканирования можно комбинировать различные ключи, которые позволяют эффективнее исследовать большую совокупность узлов за один раз:

********************* important ***************************
    Ключ -sV позволяет узнать версию используемых служб.
    Ключ -sL позволяет определить имя сетевого узла, сканирование которого и происходит.
    Ключ -v выводит подробную информацию о результатах сканирования.
    Ключ -6 позволит использовать при сканировании IPv6 вместо IPv4.
    Ключ -Pn позволяет отключить проверки доступности узла с помощьюICMPпакетов, так как некоторые FireWall настроены на откидывание данных пакетов, в следствии чего не удастся просканировать узел. Однако данный ключ замедляет сканирование системы.

Также можно использовать нестандартные методики сканирования для улучшения результата, например, сканирование с помощью кастомизации флагов: данный тип сканирования родился из особенностей реализации протоколов по соглашению RFC. Суть метода в том, что открытие/закрытие порта можно выявить с помощью особенности: любой пакет, не содержащий установленного бита SYN, RST или ACK, повлечет за собой отправку RST в ответ в случае, если порт закрыт, или не повлечет никакого ответа, если порт открыт. Если ни один из этих битов не установлен, то любая комбинация трех оставшихся (FIN, PSH и URG) будет являться правильной. В nmap для этого используются следующие ключи:

    Null сканирование (-sN): не устанавливаются никакие биты (Флагов в TCP заголовке 0).
    FIN сканирование (-sF): устанавливается только TCP FIN бит.
    Xmas сканирование (-sX): устанавливаются FIN, PSH и URG флаги.
    TCP ACK сканирование (-sA): данный тип сканирование направлен на изучение особенностей реагирования Firewall. Если порт не фильтруется, то будет возвращаться TCP ответ с флагом RST.
    TCP Window сканирование (-sW): данный тип сканирование похож сутью работы на TCP ACK, но при этом способен отпределять, закрыт или открыт порт за счёт анализа поля TCP Window в RST ответе. В некоторых системах открытые порты используют положительное значение этого поля (даже в RST пакетах), а закрытые — нулевое.
    TCP сканирование Мэймона (-sM): этот тип сканирования носит имя своего первооткрывателя, Уриела Мэймона. Техника практически такая же, как и при NULL, FIN и Xmas сканированиях, только в качестве запросов используются запросы FIN/ACK. Согласно RFC 793 (TCP), в ответ на такой запрос должен быть сгенерирован RST пакет, если порт открыт или закрыт. Однако многие BSD системы просто отбрасывают пакет, если порт открыт.
    Зомби сканирование (-sI): данный метод сканирование позволяет полностью анонимно просканировать узел на информацию о состояние портов, так как сканирование происходит от лица другого узла.
    FTP bounce сканирование (-b): данный метод сканирования основан на возможности одного FTP сервера обмениваться файлами с другим FTP сервером. Этот метод позволяет достигнуть анонимности, но сейчас крайне мало шансов, что он сработает, так как многие FTP сервера пере конфигурированы так, что они не могут отправлять между собой файлы.

5. Дополнительные материалы

Ссылка на официальную документацию: https://nmap.org/man/ru/
